<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />



</head>

<body class="bg-light">
    <%- include('layouts/nav.ejs') %>
    <%- include('partials/loading-overlay.ejs') %>

    <div class="container-fluid px-3 px-lg-4 mt-3">
        <div class="row">

            <!-- SIDEBAR COLUMN -->
            <aside class="col-lg-2 col-md-3">
                <%- include('partials/sidebar.ejs') %>
            </aside>

            <main class="col-lg-9 col-md-8">
                <!-- Header / Controls -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">

                    <!-- Title + Count -->
                    <div>
                        <h4 class="fw-bold mb-0">Products</h4>
                        <small class="text-muted">
                            <%= products.length %> item<%= products.length !== 1 ? 's' : '' %>
                        </small>
                    </div>

                    <!-- Controls -->
                    <div class="d-flex align-items-center gap-2">

                        <!-- Sort -->
                        <form method="GET">
                            <select name="sort" class="form-select form-select-sm" onchange="applySort(this.value)">
                                <option value="">Sort by</option>
                                <option value="price_asc">Price: Low â†’ High</option>
                                <option value="price_desc">Price: High â†’ Low</option>
                                <option value="latest">Newest</option>
                            </select>
                        </form>

                        <!-- Grid Density Toggle -->
                        <div class="btn-group btn-group-sm" role="group">

                            <button type="button" class="btn btn-outline-secondary" onclick="setGrid('dense')"
                                title="Compact view">
                                <i class="bi bi-grid-3x3-gap"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary active" onclick="setGrid('normal')"
                                title="Normal view">
                                <i class="bi bi-grid"></i>
                            </button>

                        </div>
                        <button class="btn btn-primary mr-2" id="export-csv-btn"
                            data-products='<%- JSON.stringify(products) %>'>
                            <i class="bi bi-cloud-download" id="down-logo"></i>
                            Export CSV

                        </button>
                        <button class="btn btn-primary mr-2 d-none" id="exporting-csv-btn">
                            <span class="spinner-border spinner-border-sm ms-2" id="spinner"></span>
                            Exporting...
                        </button>


                    </div>
                </div>

                <!-- Products Grid -->
                <% if (products.length > 0) { %>
                <div id="productGrid" class="row g-3 normal-grid">
                    <% products.forEach(product => { %>
                    <%- include('partials/product-card', { product }) %>
                    <% }) %>
                </div>
                <% } else { %>
                <!-- Empty State -->
                <div class="text-center py-5">
                    <i class="bi bi-box-seam fs-1 text-muted"></i>
                    <h5 class="mt-3">No products found</h5>
                    <p class="text-muted mb-3">
                        Try adjusting filters or add a new product.
                    </p>
                    <a href="/web/product/add" class="btn btn-primary">
                        Add Product
                    </a>
                </div>
                <% } %>

            </main>

        </div>
    </div>


    <!-- SUCCESS TOAST -->
    <% if (success && success.length > 0) { %>
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div class="toast show align-items-center text-white bg-success border-0">
            <div class="d-flex">
                <div class="toast-body">
                    <%= success[0] %>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
            </div>
        </div>
    </div>
    <% } %>
    <%- include("layouts/footer.ejs") %>
    <!-- ERROR TOAST -->
    <% if (error && error.length > 0) { %>
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div class="toast show align-items-center text-white bg-danger border-0">
            <div class="d-flex">
                <div class="toast-body">
                    <%= error[0] %>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
            </div>
        </div>
    </div>
    <% } %>


    <script>
        setTimeout(() => {
            document.querySelectorAll(".toast").forEach(toast => toast.remove());
        }, 3000);
        function setGrid(type) {
            const grid = document.getElementById("productGrid");
            grid.classList.remove("normal-grid", "dense-grid");
            grid.classList.add(type + "-grid");

            document
                .querySelectorAll(".btn-group .btn")
                .forEach(btn => btn.classList.remove("active"));

            event.target.closest("button").classList.add("active");
        }
    </script>
    <style>
        /* Normal grid (default) */
        .normal-grid>div {
            transition: all 0.2s ease;
        }

        /* Dense grid = more cards per row */
        .dense-grid>div {
            flex: 0 0 auto;
        }

        @media (min-width: 1400px) {
            .normal-grid>div {
                width: 25%;
                /* 4 cards */
            }

            .dense-grid>div {
                width: 16.66%;
                /* 6 cards */
            }
        }

        @media (min-width: 992px) and (max-width: 1399px) {
            .normal-grid>div {
                width: 33.33%;
                /* 3 cards */
            }

            .dense-grid>div {
                width: 25%;
                /* 4 cards */
            }

            aside {
                max-width: 260px;
                /* hard limit */
            }

            @media (max-width: 992px) {
                aside {
                    max-width: 100%;
                }
            }
        }
    </style>
    <script>
        function applySort(sortValue) {
            const params = new URLSearchParams(window.location.search);

            if (sortValue)
            {
                params.set("sort", sortValue);
            } else
            {
                params.delete("sort");
            }

            window.location.href =
                window.location.pathname + "?" + params.toString();
        }
    </script>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

    document.getElementById("export-csv-btn").addEventListener("click", async function (e) {
        const products = JSON.parse(e.target.dataset.products)
        e.target.classList.add("d-none")
        document.getElementById("exporting-csv-btn").classList.remove("d-none")
        const res = await fetch("/web/products/generate-csv", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(products),
        })
        if (res.ok)
        {
            e.target.classList.remove("d-none")
            document.getElementById("exporting-csv-btn").classList.add("d-none")
        }

        else
        {
            alert("something went wrong exporting csv")
            e.target.classList.remove("d-none")
            document.getElementById("exporting-csv-btn").classList.add("d-none")
        }
        // ðŸ”½ convert to blob
        const blob = await res.blob();

        // ðŸ”½ create download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "products.csv";
        a.click();

        window.URL.revokeObjectURL(url);
    })
    function showLoader() {
        document.getElementById("loadingOverlay")
            .classList.remove("d-none");
    }

    function hideLoader() {
        document.getElementById("loadingOverlay")
            .classList.add("d-none");
    }
    document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", showLoader);
    });
</script>


</html>