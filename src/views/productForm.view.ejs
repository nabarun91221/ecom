<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title><%= product ? 'Edit Product' : 'Add Product' %></title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>


<body class="bg-light">
  <div class="container py-4">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="fw-bold">
        <%= product ? 'Edit Product' : 'Add New Product' %>
      </h4>
      <a href="/web/products" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>

    <!-- Product Form -->
    <form action="<%= product ? `/web/product/edit/${product._id}` : '/web/product/add' %>" method='POST'
      enctype="multipart/form-data" class="row g-4">

      <!-- LEFT COLUMN -->
      <div class="col-lg-8">

        <!-- Name & Description -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Name and Description</h6>

            <div class="mb-3">
              <label class="form-label">Product Name</label>
              <input type="text" name="name" class="form-control" value="<%= product?.name || '' %>" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="desc" rows="4" class="form-control"><%= product?.desc|| '' %></textarea>
            </div>
          </div>
        </div>

        <!-- Category & Brand -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Category</h6>

            <label class="form-label">Brand</label>
            <select name="brand" class="form-select" required>
              <option value="">Select Brand</option>
              <% brands.forEach(brand => { %>
              <option value="<%= brand %>" <%= product?.brand === brand ? 'selected' : '' %>>
                <%= brand %>
              </option>
              <% }) %>
            </select>
          </div>
          <div class="card-body">
            <label class="form-label">Category</label>
            <select name="category" class="form-select" required>
              <option value="">Select Category</option>
              <% categories.forEach(category => { %>
              <option value="<%= category %>" <%= product?.category === category ? 'selected' : '' %>>
                <%= category %>
              </option>
              <% }) %>
            </select>
          </div>
        </div>
        <!-- Images -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Product Images</h6>

            <label class="form-label">Upload Images</label>
            <input type="file" name="images" class="form-control" multiple accept="image/*" />
            <div id="preview" class="row g-3 mt-2"></div>

            <!-- Reference / Existing Images -->
            <% if (product && product.images && product.images.length > 0) { %>
            <div class="mt-3">
              <label class="form-label">Existing Images</label>

              <div class="row g-3">
                <% product.images.forEach(img => { %>
                <div class="col-md-4 col-sm-6">
                  <div class="border rounded overflow-hidden bg-white">
                    <img src="<%= img %>" alt="product" class="w-100" style="height:180px; object-fit:cover;" />
                  </div>
                </div>
                <% }) %>
              </div>

            </div>
            <% } %>

            <div class="form-text mt-2">
              You can select multiple images. First image will be treated as cover.
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-lg-4">

        <!-- Pricing -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Pricing</h6>

            <label class="form-label">Price</label>
            <input type="number" name="price" class="form-control" value="<%= product?.price || '' %>" required />
          </div>
        </div>

        <!-- Sizes -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Size</h6>

            <% sizes.forEach(size => { %>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="size" value="<%= size %>"
                <%= product?.size === size ? 'checked' : '' %> required />
              <label class="form-check-label"><%= size %></label>
            </div>
            <% }) %>
          </div>
        </div>


        <!-- Colors -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Color</h6>

            <label class="form-label">Color</label>
            <input type="text" name="color" class="form-control" placeholder="e.g. Red, Blue, Midnight Black"
              value="<%= product?.color || '' %>" required />
          </div>
        </div>


        <!-- Stock -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Stock</h6>

            <label class="form-label">Stock Quantity</label>
            <input type="number" name="stock" class="form-control" value="<%= product?.stock || '' %>" />
          </div>
        </div>

        <!-- Status -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Status</h6>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="status" value="active"
                <%= product?.status === 'active' ? 'checked' : '' %> />
              <label class="form-check-label">Active</label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="status" value="inactive"
                <%= product?.status === 'inactive' ? 'checked' : '' %> />
              <label class="form-check-label">Inactive</label>
            </div>

          </div>
        </div>

      </div>



      <!-- Submit -->
      <div class="col-12 text-end mt-3">
        <button class="btn btn-secondary me-2" type="reset">Reset</button>
        <button id="submit-btn" class="btn btn-success" type="submit">
          <%= product ? 'Update Product' : 'Add Product' %>
        </button>
      </div>

    </form>
  </div>
  <!-- SUCCESS TOAST -->
  <% if (success && success.length > 0) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast show align-items-center text-white bg-success border-0">
      <div class="d-flex">
        <div class="toast-body">
          <%= success[0] %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
      </div>
    </div>
  </div>
  <% } %>

  <!-- ERROR TOAST -->
  <% if (error && error.length > 0) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast show align-items-center text-white bg-danger border-0">
      <div class="d-flex">
        <div class="toast-body">
          <%= error[0] %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
      </div>
    </div>
  </div>
  <% } %>
  <script>
    setTimeout(() => {
      document.querySelectorAll(".toast").forEach(toast => toast.remove());
    }, 3000);

    document.querySelector('input[name="images"]').addEventListener('change', function (e) {
      const preview = document.getElementById('preview');
      preview.innerHTML = "";

      [...e.target.files].forEach(file => {
        const reader = new FileReader();

        reader.onload = function (event) {
          const col = document.createElement("div");
          col.className = "col-md-4 col-sm-6";

          col.innerHTML = `
          <div class="border rounded overflow-hidden">
            <img src="${event.target.result}" 
                 style="width:100%;height:180px;object-fit:cover;">
          </div>
        `;

          preview.appendChild(col);
        };

        reader.readAsDataURL(file);
      });
    });
  </script>
</body>

</html>