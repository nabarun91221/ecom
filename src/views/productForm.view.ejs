<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title><%= product ? 'Edit Product' : 'Add Product' %></title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .img-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      color: #333;
      transition: all .2s;
      z-index: 2;
    }

    .img-delete-btn:hover {
      background: rgba(220, 53, 69, 0.9);
      color: white;
      transform: scale(1.1);
    }
  </style>

</head>


<body class="bg-light">
  <%- include('partials/loading-overlay.ejs') %>
  <div class="container py-4">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="fw-bold">
        <%= product ? 'Edit Product' : 'Add New Product' %>
      </h4>
      <a href="/web/products" class="btn btn-outline-secondary btn-sm">Back</a>

    </div>
    <div class="mb-4">
      <button class="btn btn-outline-primary " data-bs-toggle="modal" data-bs-target="#csvUploadModal">
        Import CSV
      </button>
    </div>



    <!-- Product Form -->
    <form action="<%= product ? `/web/product/edit/${product._id}` : '/web/product/add' %>" method='POST'
      enctype="multipart/form-data" class="row g-4">

      <!-- LEFT COLUMN -->
      <div class="col-lg-8">

        <!-- Name & Description -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Name and Description</h6>

            <div class="mb-3">
              <label class="form-label">Product Name</label>
              <input type="text" name="name" class="form-control" value="<%= product?.name || '' %>" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="desc" rows="4" class="form-control"><%= product?.desc|| '' %></textarea>
            </div>
          </div>
        </div>

        <!-- Category & Brand -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Category</h6>

            <label class="form-label">Brand</label>
            <select name="brand" class="form-select" required>
              <option value="">Select Brand</option>
              <% brands.forEach(brand => { %>
              <option value="<%= brand %>" <%= product?.brand === brand ? 'selected' : '' %>>
                <%= brand %>
              </option>
              <% }) %>
            </select>
          </div>
          <div class="card-body">
            <label class="form-label">Category</label>
            <select name="category" class="form-select" required>
              <option value="">Select Category</option>
              <% categories.forEach(category => { %>
              <option value="<%= category %>" <%= product?.category === category ? 'selected' : '' %>>
                <%= category %>
              </option>
              <% }) %>
            </select>
          </div>
        </div>
        <!-- Images -->
        <div class="card shadow-sm mt-4 mw-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Product Images</h6>

            <label class="form-label">Upload Images</label>
            <input type="file" name="images" class="form-control" multiple accept="image/*" />
            <div id="preview" class="row g-3 mt-2"></div>

            <!-- Reference / Existing Images -->
            <% if (product && product.images && product.images.length > 0) { %>
            <div class="mt-3">
              <label class="form-label">Existing Images</label>

              <div class="row g-3">
                <% product.images.forEach(img => { %>
                <div class="col-md-4 col-sm-6">
                  <div class="border rounded overflow-hidden bg-white position-relative">

                    <button type="button" class="img-delete-btn" data-product-id="<%= product._id %>"
                      data-image-public-id="<%=img.public_id%>">
                      âœ•
                    </button>

                    <img src="<%= img.url %>" alt="product" class="w-100" style="height:180px; object-fit:cover;" />
                  </div>
                </div>
                <% }) %>
              </div>

            </div>
            <% } %>

            <div class="form-text mt-2">
              You can select multiple images. First image will be treated as cover.
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-lg-4">

        <!-- Pricing -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Pricing</h6>

            <label class="form-label">Price</label>
            <input type="number" name="price" class="form-control" value="<%= product?.price || '' %>" required />
          </div>
        </div>

        <!-- Sizes -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Size</h6>

            <% sizes.forEach(size => { %>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="size" value="<%= size %>"
                <%= product?.size === size ? 'checked' : '' %> required />
              <label class="form-check-label"><%= size %></label>
            </div>
            <% }) %>
          </div>
        </div>


        <!-- Colors -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Color</h6>

            <label class="form-label">Color</label>
            <input type="text" name="color" class="form-control" placeholder="e.g. Red, Blue, Midnight Black"
              value="<%= product?.color || '' %>" required />
          </div>
        </div>


        <!-- Stock -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Stock</h6>

            <label class="form-label">Stock Quantity</label>
            <input type="number" name="stock" class="form-control" value="<%= product?.stock || '' %>" />
          </div>
        </div>

        <!-- Status -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Status</h6>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="status" value="active"
                <%= product?.status === 'active' ? 'checked' : '' %> />
              <label class="form-check-label">Active</label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="status" value="inactive"
                <%= product?.status === 'inactive' ? 'checked' : '' %> />
              <label class="form-check-label">Inactive</label>
            </div>

          </div>
        </div>

      </div>



      <!-- Submit -->
      <div class="col-12 text-end mt-3">
        <button class="btn btn-secondary me-2" type="reset">Reset</button>
        <button id="submit-btn" class="btn btn-success" type="submit">
          <%= product ? 'Update Product' : 'Add Product' %>
        </button>
      </div>

    </form>
  </div>

  <!-- CSV Upload Modal -->
  <div class="modal fade" id="csvUploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Upload CSV File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form action="/web/products/import-csv" method="POST" enctype="multipart/form-data">

          <div class="modal-body">

            <div class="mb-3">
              <label class="form-label">Select CSV File</label>
              <input type="file" name="csv" accept=".csv,text/csv" class="form-control" required>
            </div>

            <div class="form-text">
              Only .csv files are supported.
            </div>

          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>

            <button type="submit" class="btn btn-primary">
              Upload CSV
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <!-- SUCCESS TOAST -->
  <% if (success && success.length > 0) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast show align-items-center text-white bg-success border-0">
      <div class="d-flex">
        <div class="toast-body">
          <%= success[0] %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
      </div>
    </div>
  </div>
  <% } %>

  <!-- ERROR TOAST -->
  <% if (error && error.length > 0) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast show align-items-center text-white bg-danger border-0">
      <div class="d-flex">
        <div class="toast-body">
          <%= error[0] %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
      </div>
    </div>
  </div>

  <% } %>
  <script>
    function showLoader() {
      document.getElementById("loadingOverlay")
        .classList.remove("d-none");
    }

    function hideLoader() {
      document.getElementById("loadingOverlay")
        .classList.add("d-none");
    }
    document.querySelectorAll("form").forEach(form => {
      form.addEventListener("submit", showLoader);
    });
    setTimeout(() => {
      document.querySelectorAll(".toast").forEach(toast => toast.remove());
    }, 3000);

    document.querySelector('input[name="images"]').addEventListener('change', function (e) {
      const preview = document.getElementById('preview');
      preview.innerHTML = "";

      [...e.target.files].forEach(file => {
        const reader = new FileReader();

        reader.onload = function (event) {
          const col = document.createElement("div");
          col.className = "col-md-4 col-sm-6";

          col.innerHTML = `
          <div class="border rounded overflow-hidden">
            <img src="${event.target.result}" 
                 style="width:100%;height:200px;object-fit:cover;">
          </div>
        `;

          preview.appendChild(col);
        };

        reader.readAsDataURL(file);
      });
    });


    document.querySelectorAll(".img-delete-btn").forEach(btn => {
      btn.addEventListener("click", async function (e) {

        const imageId = this.dataset.imagePublicId;
        const productId = this.dataset.productId;

        showLoader()
        const res = await fetch(`/web/products/delete/image/${productId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ imageId: imageId })
        })
        if (res.ok)
        {
          this.closest(".col-md-4").remove();
          hideLoader()
        }
        console.log({ imageId: imageId, productId: productId });
        e.preventDefault();
      });
    });



  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>